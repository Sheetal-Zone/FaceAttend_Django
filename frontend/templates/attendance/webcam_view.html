{% extends 'base.html' %}

{% block title %}Camera Attendance - Face Attendance System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-camera"></i> Camera Attendance
                </h1>
                <a href="{% url 'attendance:dashboard' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Camera Preview -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-video"></i> Live Camera Feed
                    </h5>
                </div>
                <div class="card-body">
                    <div class="camera-container">
                        <video id="cameraVideo" autoplay muted playsinline class="w-100" style="max-height: 500px; border-radius: 8px;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                    </div>
                    
                    <div class="camera-controls mt-3">
                        <button id="startCameraBtn" class="btn btn-success me-2">
                            <i class="fas fa-play"></i> Start Camera
                        </button>
                        <button id="stopCameraBtn" class="btn btn-danger me-2" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Camera
                        </button>
                        <button id="captureBtn" class="btn btn-primary me-2" style="display: none;">
                            <i class="fas fa-camera"></i> Capture & Detect
                        </button>
                        <span id="cameraStatus" class="badge bg-secondary">Camera not started</span>
                    </div>
                    
                    <div id="detectionResults" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Detection Results</h6>
                            <div id="detectionInfo"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration and Status -->
        <div class="col-lg-4">
            <!-- Camera Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog"></i> Camera Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Camera Device:</label>
                        <select id="cameraDevice" class="form-select">
                            <option value="">Auto-detect available camera</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Resolution:</label>
                        <select id="resolution" class="form-select">
                            <option value="640,480">640x480</option>
                            <option value="1280,720" selected>1280x720 (HD)</option>
                            <option value="1920,1080">1920x1080 (Full HD)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Confidence Threshold:</label>
                        <input type="range" id="confidenceThreshold" class="form-range" min="0.1" max="1.0" step="0.1" value="0.7">
                        <div class="text-center">
                            <span id="confidenceValue">0.7</span>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoMarkAttendance" checked>
                        <label class="form-check-label" for="autoMarkAttendance">
                            Auto-mark attendance when face is recognized
                        </label>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>Camera Features:</strong><br>
                            • Automatic camera detection<br>
                            • Real-time face detection<br>
                            • Student recognition<br>
                            • Automatic attendance marking
                        </small>
                    </div>
                </div>
            </div>

            <!-- Recent Attendance -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Recent Attendance
                    </h5>
                </div>
                <div class="card-body">
                    <div id="recentAttendance">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Recognition Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-check"></i> Student Recognized
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="studentInfo"></div>
                    <div class="mt-3">
                        <label class="form-label">Confidence Score:</label>
                        <div class="progress">
                            <div id="confidenceBar" class="progress-bar" role="progressbar"></div>
                        </div>
                        <small class="text-muted" id="confidenceText"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="markAttendanceBtn">
                        <i class="fas fa-check"></i> Mark Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cameraStream = null;
let videoElement = null;
let canvasElement = null;
let currentStudent = null;
let currentConfidence = 0;
let availableCameras = [];

document.addEventListener('DOMContentLoaded', function() {
    videoElement = document.getElementById('cameraVideo');
    canvasElement = document.getElementById('cameraCanvas');
    
    // Initialize controls
    initializeControls();
    
    // Load recent attendance
    loadRecentAttendance();
    
    // Update confidence display
    document.getElementById('confidenceThreshold').addEventListener('input', function() {
        document.getElementById('confidenceValue').textContent = this.value;
    });
    
    // Detect available cameras
    detectAvailableCameras();
});

function detectAvailableCameras() {
    // Get available camera devices
    navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            availableCameras = videoDevices;
            
            const cameraSelect = document.getElementById('cameraDevice');
            cameraSelect.innerHTML = '<option value="">Auto-detect available camera</option>';
            
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = device.label || `Camera ${index + 1}`;
                cameraSelect.appendChild(option);
            });
            
            console.log('Available cameras:', availableCameras);
        })
        .catch(error => {
            console.error('Error detecting cameras:', error);
        });
}

function initializeControls() {
    // Camera functions
    async function startCamera() {
        try {
            const deviceId = document.getElementById('cameraDevice').value;
            const resolution = document.getElementById('resolution').value.split(',');
            
            const constraints = {
                video: {
                    width: { ideal: parseInt(resolution[0]) },
                    height: { ideal: parseInt(resolution[1]) }
                }
            };
            
            // If specific camera is selected, use it
            if (deviceId !== '') {
                constraints.video.deviceId = { exact: availableCameras[deviceId].deviceId };
            }
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraStream = stream;
            videoElement.srcObject = stream;
            
            // Update UI
            document.getElementById('startCameraBtn').style.display = 'none';
            document.getElementById('stopCameraBtn').style.display = 'inline-block';
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('cameraStatus').textContent = 'Camera active';
            document.getElementById('cameraStatus').className = 'badge bg-success';
            
            showAlert('Camera started successfully!', 'success');
            
            // Start FastAPI camera processor
            startCameraProcessor();
            
        } catch (error) {
            console.error('Error starting camera:', error);
            showAlert('Failed to start camera: ' + error.message, 'danger');
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        
        if (videoElement) {
            videoElement.srcObject = null;
        }
        
        // Update UI
        document.getElementById('startCameraBtn').style.display = 'inline-block';
        document.getElementById('stopCameraBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'none';
        document.getElementById('cameraStatus').textContent = 'Camera stopped';
        document.getElementById('cameraStatus').className = 'badge bg-secondary';
        
        showAlert('Camera stopped successfully!', 'success');
    }

    // Event listeners for camera buttons
    document.getElementById('startCameraBtn').addEventListener('click', startCamera);
    document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
    document.getElementById('captureBtn').addEventListener('click', captureAndDetect);
    document.getElementById('markAttendanceBtn').addEventListener('click', markAttendance);
}

async function startCameraProcessor() {
    try {
        // Start FastAPI camera processor (laptop camera endpoint works for any camera)
        const response = await fetch('/api/v1/detection/laptop-camera/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAccessToken()}`
            }
        });
        
        if (response.ok) {
            console.log('Camera processor started successfully');
        } else {
            console.warn('Failed to start camera processor, but camera is working');
        }
    } catch (error) {
        console.warn('Camera processor not available, but camera is working:', error);
    }
}

function captureAndDetect() {
    if (!cameraStream) {
        showMessage('Please start the camera first.', 'warning');
        return;
    }
    
    // Set canvas dimensions
    canvasElement.width = videoElement.videoWidth;
    canvasElement.height = videoElement.videoHeight;
    
    // Draw video frame to canvas
    const ctx = canvasElement.getContext('2d');
    ctx.drawImage(videoElement, 0, 0);
    
    // Simulate face detection (replace with actual face recognition)
    simulateFaceDetection();
}

function simulateFaceDetection() {
    // This is a simulation - replace with actual face recognition logic
    const students = [
        { id: 1, name: 'John Doe', roll_number: 'CS001', confidence: 0.85 },
        { id: 2, name: 'Jane Smith', roll_number: 'CS002', confidence: 0.92 },
        { id: 3, name: 'Bob Johnson', roll_number: 'CS003', confidence: 0.78 }
    ];
    
    const threshold = parseFloat(document.getElementById('confidenceThreshold').value);
    const randomStudent = students[Math.floor(Math.random() * students.length)];
    const confidence = randomStudent.confidence + (Math.random() - 0.5) * 0.1;
    
    if (confidence >= threshold) {
        currentStudent = randomStudent;
        currentConfidence = confidence;
        showStudentModal(randomStudent, confidence);
    } else {
        showMessage('No face recognized with sufficient confidence.', 'warning');
    }
}

function showStudentModal(student, confidence) {
    const studentInfo = document.getElementById('studentInfo');
    const confidenceBar = document.getElementById('confidenceBar');
    const confidenceText = document.getElementById('confidenceText');
    
    studentInfo.innerHTML = `
        <div class="text-center">
            <i class="fas fa-user-circle fa-3x text-primary mb-3"></i>
            <h5>${student.name}</h5>
            <p class="text-muted">Roll Number: ${student.roll_number}</p>
        </div>
    `;
    
    const percentage = Math.round(confidence * 100);
    confidenceBar.style.width = percentage + '%';
    confidenceBar.className = `progress-bar ${percentage >= 80 ? 'bg-success' : percentage >= 60 ? 'bg-warning' : 'bg-danger'}`;
    confidenceText.textContent = `${percentage}% (${confidence.toFixed(3)})`;
    
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

function markAttendance() {
    if (!currentStudent) return;
    
    const autoMark = document.getElementById('autoMarkAttendance').checked;
    
    fetch('{% url "attendance:webcam_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            student_id: currentStudent.id,
            confidence_score: currentConfidence,
            camera_location: 'Camera',
            processing_time: 0.1,
            frame_resolution: '1280x720'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Attendance marked for ${data.student_name}!`, 'success');
            loadRecentAttendance();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('studentModal'));
            modal.hide();
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error marking attendance.', 'error');
    });
}

function loadRecentAttendance() {
    fetch('{% url "attendance:api_attendance_stats" %}')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('recentAttendance');
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-6">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Today</h6>
                        <h4 class="text-primary mb-0">${data.today_attendance}</h4>
                    </div>
                </div>
                <div class="col-6">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Camera</h6>
                        <h4 class="text-success mb-0">${data.webcam_attendance}</h4>
                    </div>
                </div>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading attendance stats:', error);
    });
}

function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Helper function to get access token (placeholder)
function getAccessToken() {
    // This should be implemented to get the actual token from Django session
    // For now, return empty string (will cause 403 errors until implemented)
    return '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.camera-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
}

.camera-container video {
    display: block;
    width: 100%;
    height: auto;
}

.camera-controls {
    text-align: center;
}

#detectionResults {
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}

.progress {
    height: 20px;
}

.progress-bar {
    transition: width 0.3s ease;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid #dee2e6;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.alert {
    margin-bottom: 1rem;
}

.badge {
    font-size: 0.875em;
}
</style>
{% endblock %}
