{% extends 'base.html' %}

{% block title %}Detection Logs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-ul me-2"></i>Detection Logs</h2>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="refreshLogs()">
            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
        </button>
        <button class="btn btn-outline-danger" onclick="clearLogs()">
            <i class="bi bi-trash me-2"></i>Clear Logs
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <h3 class="card-title">{{ total_detections }}</h3>
                <p class="card-text">Total Detections</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <h3 class="card-title">{{ total_faces_detected }}</h3>
                <p class="card-text">Faces Detected</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <h3 class="card-title">{{ total_students_recognized }}</h3>
                <p class="card-text">Students Recognized</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <h3 class="card-title">{{ avg_processing_time|floatformat:2 }}s</h3>
                <p class="card-text">Avg Processing Time</p>
            </div>
        </div>
    </div>
</div>

<!-- Detection Logs Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Timestamp</th>
                        <th>Camera</th>
                        <th>Faces Detected</th>
                        <th>Students Recognized</th>
                        <th>Processing Time</th>
                        <th>Frame Resolution</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            <small>{{ log.timestamp|date:"M d, Y" }}</small><br>
                            <small class="text-muted">{{ log.timestamp|time:"H:i:s" }}</small>
                        </td>
                        <td>
                            {% if log.camera %}
                                <span class="badge bg-info">{{ log.camera.name }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-primary">{{ log.faces_detected }}</span>
                        </td>
                        <td>
                            <span class="badge bg-success">{{ log.students_recognized }}</span>
                        </td>
                        <td>
                            {% if log.processing_time %}
                                <span class="badge bg-secondary">{{ log.processing_time|floatformat:2 }}s</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ log.frame_resolution|default:"-" }}</small>
                        </td>
                        <td>
                            {% if log.error_message %}
                                <span class="badge bg-danger" title="{{ log.error_message }}">Error</span>
                            {% else %}
                                <span class="badge bg-success">Success</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">No detection logs found</p>
                            <p class="text-muted">Detection logs will appear here when the face detection system is running.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if logs.has_other_pages %}
        <nav aria-label="Detection logs pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if logs.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ logs.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}

                {% for num in logs.paginator.page_range %}
                    {% if logs.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > logs.number|add:'-3' and num < logs.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if logs.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ logs.next_page_number }}">Next</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Error Details Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Error Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="errorDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshLogs() {
    location.reload();
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all detection logs? This action cannot be undone.')) {
        fetch('/detection-logs/clear/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to clear logs: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while clearing logs.');
        });
    }
}

// Auto-refresh logs every 30 seconds
setInterval(function() {
    // Only refresh if the page is visible
    if (!document.hidden) {
        // You can implement a more sophisticated refresh here
        // For now, we'll just update the timestamp
        console.log('Logs can be refreshed...');
    }
}, 30000);
</script>
{% endblock %}
