{% extends 'base.html' %}

{% block title %}Camera Streams{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-camera-video me-2"></i>Camera Streams</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
        <i class="bi bi-plus-circle me-2"></i>Add Camera
    </button>
</div>

<!-- Camera Streams Grid -->
<div class="row">
    {% for camera in cameras %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-video"></i> {{ camera.name }}
                </h6>
                <span class="badge {% if camera.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if camera.is_active %}Active{% else %}Inactive{% endif %}
                </span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Type:</strong> {{ camera.camera_type|title }}<br>
                    <strong>URL:</strong> {{ camera.camera_url|truncatechars:30 }}<br>
                    <strong>Location:</strong> {{ camera.location|default:"Not specified" }}
                </div>
                
                <div class="d-grid gap-2">
                    {% if camera.is_active %}
                        <button class="btn btn-danger btn-sm" onclick="stopCamera({{ camera.id }})">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    {% else %}
                        <button class="btn btn-success btn-sm" onclick="startCamera({{ camera.id }})">
                            <i class="fas fa-play"></i> Start
                        </button>
                    {% endif %}
                    <a href="{% url 'attendance:live_detection' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye"></i> View
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Laptop Camera Integration -->
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 border-primary">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-laptop"></i> Laptop Camera
                </h6>
                <span id="laptopCameraStatus" class="badge bg-secondary">Inactive</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Type:</strong> Built-in Camera<br>
                    <strong>Resolution:</strong> HD (1280x720)<br>
                    <strong>Features:</strong> Face Detection, Recognition
                </div>
                
                <div class="d-grid gap-2">
                    <button id="startLaptopCameraBtn" class="btn btn-success btn-sm" onclick="startLaptopCamera()">
                        <i class="bi bi-play-circle"></i> Start
                    </button>
                    <button id="stopLaptopCameraBtn" class="btn btn-danger btn-sm" onclick="stopLaptopCamera()" style="display: none;">
                        <i class="bi bi-stop-circle"></i> Stop
                    </button>
                    <a href="{% url 'attendance:live_detection' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye"></i> View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Camera Modal -->
<div class="modal fade" id="addCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Camera Stream</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    {% include 'attendance/camera_form.html' with camera=None %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Camera</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Camera Modal -->
<div class="modal fade" id="editCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Camera Stream</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCameraForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div id="editCameraFormContent">
                        <!-- Form will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Camera</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Camera management functions
    function startCamera(cameraId) {
        // Implementation for starting external cameras
        console.log('Starting camera:', cameraId);
        // Add your camera start logic here
    }

    function stopCamera(cameraId) {
        // Implementation for stopping external cameras
        console.log('Stopping camera:', cameraId);
        // Add your camera stop logic here
    }

    // Laptop camera functions
    async function startLaptopCamera() {
        try {
            // Start FastAPI laptop camera processor
            const response = await fetch('/api/v1/detection/laptop-camera/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAccessToken()}`
                }
            });
            
            if (response.ok) {
                // Update UI
                document.getElementById('startLaptopCameraBtn').style.display = 'none';
                document.getElementById('stopLaptopCameraBtn').style.display = 'block';
                document.getElementById('laptopCameraStatus').textContent = 'Active';
                document.getElementById('laptopCameraStatus').className = 'badge bg-success';
                
                showAlert('Laptop camera started successfully!', 'success');
            } else {
                throw new Error('Failed to start laptop camera processor');
            }
        } catch (error) {
            console.error('Error starting laptop camera:', error);
            showAlert('Failed to start laptop camera: ' + error.message, 'danger');
        }
    }

    async function stopLaptopCamera() {
        try {
            // Stop FastAPI laptop camera processor
            const response = await fetch('/api/v1/detection/laptop-camera/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAccessToken()}`
                }
            });
            
            if (response.ok) {
                // Update UI
                document.getElementById('startLaptopCameraBtn').style.display = 'block';
                document.getElementById('stopLaptopCameraBtn').style.display = 'none';
                document.getElementById('laptopCameraStatus').textContent = 'Inactive';
                document.getElementById('laptopCameraStatus').className = 'badge bg-secondary';
                
                showAlert('Laptop camera stopped successfully!', 'success');
            } else {
                throw new Error('Failed to stop laptop camera processor');
            }
        } catch (error) {
            console.error('Error stopping laptop camera:', error);
            showAlert('Failed to stop laptop camera: ' + error.message, 'danger');
        }
    }

    // Helper function to get access token (placeholder)
    function getAccessToken() {
        // This should be implemented to get the actual token from Django session
        // For now, return empty string (will cause 403 errors until implemented)
        return '';
    }

    // Helper function to show alerts
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}
